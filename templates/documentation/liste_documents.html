{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}{{ titre }} - GIRREX{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>{{ titre }}</h3>
        <div>
            {% if perms.documentation.add_document %}
                <a href="{% url 'documentation:create-document' %}" class="btn btn-primary">
                    <i class="bi bi-plus-circle-fill"></i> Créer un document
                </a>
            {% endif %}
        </div>
    </div>

    <div class="card card-body mb-4">
        <form method="get" class="form">
            <div class="row g-3 align-items-end">
                <div class="col-md">
                    {{ filter.form.recherche_textuelle|as_crispy_field }}
                </div>
                <div class="col-md">
                    {{ filter.form.type_document|as_crispy_field }}
                </div>
                <div class="col-md">
                    {{ filter.form.statut|as_crispy_field }}
                </div>
                {% if filter.form.scope %}
                <div class="col-md">
                    {{ filter.form.scope|as_crispy_field }}
                </div>
                {% endif %}
                {% if filter.form.centre %}
                <div class="col-md">
                    {{ filter.form.centre|as_crispy_field }}
                </div>
                {% endif %}
                <div class="col-md-auto">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i> Filtrer
                    </button>
                </div>
            </div>
        </form>
    </div>

    <div class="table-responsive">
        <table class="table table-hover table-striped">
            <thead class="thead-light">
                <tr>
                    <th>Référence</th>
                    <th>Intitulé</th>
                    <th>Type</th>
                    <th>Périmètre</th> {# <-- NOUVELLE COLONNE #}
                    <th>Responsable Suivi</th>
                    <th>Mise en vigueur</th>
                    <th>Prochaine Échéance</th>
                    <th>Statut</th>
                </tr>
            </thead>
            <tbody>
                {% for doc in filter.qs %}
                <tr>
                    <td>
                        <a href="{% url 'documentation:detail-document' doc.id %}"><strong>{{ doc.reference }}</strong></a>
                    </td>
                    <td>{{ doc.intitulé }}</td>
                    <td>{{ doc.type_document.nom }}</td>
                    <td>
                        {# --- NOUVELLE LOGIQUE D'AFFICHAGE --- #}
                        {% if doc.centres_applicables.all %}
                            {# Si des centres sont liés, on affiche leurs codes #}
                            {% for centre in doc.centres_applicables.all %}
                                {{ centre.code_centre }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        {% else %}
                            {# Sinon, c'est un document national #}
                            <span class="badge bg-info">National</span>
                        {% endif %}
                    </td>
                    <td>{{ doc.responsable_suivi }}</td>
                    <td>{{ doc.date_mise_en_vigueur|date:"d/m/Y" }}</td>
                    <td>{{ doc.date_prochaine_echeance|date:"d/m/Y" }}</td>
                    <td>
                        <span class="badge 
                            {% if doc.statut == 'EN_VIGUEUR' %}bg-success
                            {% elif doc.statut == 'REMPLACE' %}bg-secondary
                            {% elif doc.statut == 'EN_REDACTION' %}bg-warning text-dark
                            {% else %}bg-dark
                            {% endif %}">
                            {{ doc.get_statut_display }}
                        </span>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    {# On met à jour le colspan à 8 #}
                    <td colspan="8" class="text-center text-muted">Aucun document ne correspond à vos critères.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}