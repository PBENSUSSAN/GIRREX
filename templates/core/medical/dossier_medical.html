{% extends 'base.html' %}
{% load static %}

{% block title %}{{ titre }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    
    <!-- En-t√™te -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-heart-pulse-fill me-2"></i>{{ titre }}</h2>
        <a href="{% url 'competences:dossier_agent' agent_concerne.id_agent %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Retour au dossier comp√©tences
        </a>
    </div>

    <!-- Statut Actuel -->
    <div class="card shadow-sm mb-4">
        <div class="card-header 
            {% if statut_info.libelle == 'APTE' %}bg-success text-white
            {% elif statut_info.libelle == 'INAPTE TEMPORAIRE' %}bg-warning text-dark
            {% else %}bg-danger text-white{% endif %}">
            <h5 class="mb-0">
                <i class="bi bi-clipboard-pulse me-2"></i>
                Statut M√©dical Actuel
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h3>
                        <span class="badge {{ statut_info.badge_classe }} fs-5">
                            {{ statut_info.libelle }}
                        </span>
                    </h3>
                    
                    {% if statut_info.expiration %}
                    <p class="mb-2">
                        <strong>Valide jusqu'au :</strong> 
                        <span class="{% if statut_info.classe == 'success' %}text-success{% else %}text-{{ statut_info.classe }}{% endif %} fw-bold">
                            {{ statut_info.expiration|date:"d/m/Y" }}
                        </span>
                    </p>
                    <p class="mb-2">
                        <strong>√âch√©ance dans :</strong> 
                        <span class="{% if statut_info.classe == 'success' %}text-success{% else %}text-{{ statut_info.classe }}{% endif %} fw-bold">
                            {{ statut_info.jours_restants }} jour{{ statut_info.jours_restants|pluralize }}
                        </span>
                    </p>
                    {% endif %}
                    
                    {% if statut_info.restrictions %}
                    <div class="alert alert-warning mt-3 mb-0">
                        <strong><i class="bi bi-exclamation-triangle-fill me-2"></i>Restrictions :</strong>
                        <ul class="mb-0 mt-2">
                            {% for restriction in statut_info.restrictions %}
                            <li>{{ restriction }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
                
                <div class="col-md-6 text-end">
                    {% if effective_perms.competences.change_licence %}
                    <a href="{% url 'planifier_rdv_medical' agent_concerne.id_agent %}" 
                       class="btn btn-primary mb-2">
                        <i class="bi bi-calendar-plus"></i> Planifier une visite
                    </a>
                    <br>
                    <a href="{% url 'declarer_arret_maladie' agent_concerne.id_agent %}" 
                       class="btn btn-warning">
                        <i class="bi bi-bandaid"></i> D√©clarer un arr√™t
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Prochain RDV -->
    {% if prochain_rdv %}
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">
                <i class="bi bi-calendar-event me-2"></i>
                Prochain Rendez-vous
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <p class="mb-1">
                        <strong>Date :</strong> {{ prochain_rdv.date_heure_rdv|date:"d/m/Y √† H:i" }}
                    </p>
                    <p class="mb-1">
                        <strong>Centre m√©dical :</strong> {{ prochain_rdv.organisme_medical }}
                    </p>
                    <p class="mb-1">
                        <strong>Type :</strong> {{ prochain_rdv.type_visite }}
                    </p>
                    <p class="mb-0">
                        <strong>Statut :</strong> 
                        {% if prochain_rdv.statut == 'PLANIFIE' %}
                        <span class="badge bg-primary">{{ prochain_rdv.get_statut_display }}</span>
                        {% elif prochain_rdv.statut == 'REPORTE' %}
                        <span class="badge bg-warning">{{ prochain_rdv.get_statut_display }}</span>
                        {% endif %}
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    {# Boutons pour l'agent lui-m√™me #}
                    {% if request.user.agent_profile == agent_concerne %}
                        {% if prochain_rdv.statut != 'ANNULE' and prochain_rdv.statut != 'REALISE' %}
                        <a href="{% url 'modifier_rdv_medical' prochain_rdv.id %}" 
                           class="btn btn-sm btn-warning mb-1">
                            <i class="bi bi-pencil"></i> Modifier
                        </a>
                        <br>
                        <a href="{% url 'annuler_rdv_medical' prochain_rdv.id %}" 
                           class="btn btn-sm btn-danger mb-1">
                            <i class="bi bi-x-circle"></i> Annuler
                        </a>
                        <br>
                        {% endif %}
                        <a href="{% url 'saisir_resultat_visite' prochain_rdv.id %}" 
                           class="btn btn-sm btn-success mb-1">
                            <i class="bi bi-check-circle"></i> Saisir r√©sultat
                        </a>
                        <br>
                    {% endif %}
                    
                    {# Boutons pour FORM_LOCAL #}
                    {% if effective_perms.competences.change_licence %}
                        {% if prochain_rdv.statut != 'ANNULE' and prochain_rdv.statut != 'REALISE' %}
                        <a href="{% url 'modifier_rdv_medical' prochain_rdv.id %}" 
                           class="btn btn-sm btn-outline-warning mb-1">
                            <i class="bi bi-pencil"></i> Modifier
                        </a>
                        <br>
                        {% endif %}
                        <a href="{% url 'saisir_resultat_visite' prochain_rdv.id %}" 
                           class="btn btn-sm btn-outline-success mb-1">
                            <i class="bi bi-check-circle"></i> Saisir r√©sultat
                        </a>
                        <br>
                    {% endif %}
                    
                    {# Historique visible par tous #}
                    <a href="{% url 'historique_rdv' prochain_rdv.id %}" 
                       class="btn btn-sm btn-outline-info">
                        <i class="bi bi-clock-history"></i> Historique
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    {# Aucun RDV - Proposer d'en cr√©er un #}
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="bi bi-calendar-event me-2"></i>
                Prochain Rendez-vous
            </h5>
        </div>
        <div class="card-body text-center">
            <p class="text-muted mb-3">Aucun rendez-vous planifi√©</p>
            {% if request.user.agent_profile == agent_concerne %}
            <a href="{% url 'planifier_rdv_medical' %}" class="btn btn-primary">
                <i class="bi bi-calendar-plus"></i> Planifier mon RDV
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Arr√™ts maladie EN COURS -->
    {% if arrets_en_cours %}
    <div class="card shadow-sm mb-4 border-warning">
        <div class="card-header bg-warning">
            <h5 class="mb-0">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                Arr√™ts Maladie en Cours
            </h5>
        </div>
        <div class="card-body">
            {% for arret in arrets_en_cours %}
            <div class="alert {% if arret.necessite_pfu %}alert-danger{% elif arret.proche_seuil_pfu %}alert-warning{% else %}alert-info{% endif %} mb-3">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h6 class="alert-heading">
                            {% if arret.necessite_pfu %}
                            <i class="bi bi-exclamation-octagon-fill"></i> PFU REQUIS
                            {% elif arret.proche_seuil_pfu %}
                            <i class="bi bi-exclamation-triangle-fill"></i> PFU IMMINENT
                            {% else %}
                            <i class="bi bi-info-circle-fill"></i> Arr√™t en cours
                            {% endif %}
                        </h6>
                        <p class="mb-2">
                            <strong>D√©but :</strong> {{ arret.date_debut|date:"d/m/Y" }}<br>
                            <strong>Fin pr√©vue :</strong> {{ arret.date_fin_prevue|date:"d/m/Y" }}<br>
                            <strong>Jours √©coul√©s :</strong> 
                            <span class="badge {% if arret.necessite_pfu %}bg-danger{% elif arret.proche_seuil_pfu %}bg-warning text-dark{% else %}bg-info{% endif %}">
                                {{ arret.jours_ecoules_depuis_debut }} jour{{ arret.jours_ecoules_depuis_debut|pluralize }}
                            </span>
                        </p>
                        
                        {% if arret.necessite_pfu %}
                        <div class="alert alert-danger mt-2 mb-0">
                            <strong>üö® ATTENTION :</strong> Arr√™t > 90 jours ininterrompu. Plan de Formation Personnalis√© (PFU) requis avant r√©activation de la MUA.
                        </div>
                        {% elif arret.proche_seuil_pfu %}
                        <div class="alert alert-warning mt-2 mb-0">
                            <strong>‚ö†Ô∏è ALERTE :</strong> Arr√™t approche du seuil PFU (90 jours). 
                            Reste {{ 90|add:"-"|add:arret.jours_ecoules_depuis_debut }} jour{{ 90|add:"-"|add:arret.jours_ecoules_depuis_debut|pluralize }}.
                        </div>
                        {% endif %}
                        
                        {% if arret.motif %}
                        <p class="mb-0 mt-2">
                            <small class="text-muted">Motif :</small> {{ arret.motif }}
                        </p>
                        {% endif %}
                    </div>
                    <div class="col-md-4 text-end">
                        {% if peut_gerer_arrets %}
                        <a href="{% url 'modifier-arret-maladie' arret.id %}" 
                           class="btn btn-sm btn-primary mb-1 w-100">
                            <i class="bi bi-pencil"></i> Prolonger
                        </a>
                        <a href="{% url 'cloturer-arret-maladie' arret.id %}" 
                           class="btn btn-sm btn-success mb-1 w-100">
                            <i class="bi bi-check-circle"></i> D√©clarer reprise
                        </a>
                        <a href="{% url 'annuler-arret-maladie' arret.id %}" 
                           class="btn btn-sm btn-outline-danger w-100">
                            <i class="bi bi-trash"></i> Annuler
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Arr√™ts maladie r√©cents -->
    {% if arrets_recents %}
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-bandaid-fill me-2"></i>
                Arr√™ts Maladie R√©cents (6 derniers mois)
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>P√©riode</th>
                            <th>Dur√©e</th>
                            <th>Motif</th>
                            <th>Visite reprise</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for arret in arrets_recents %}
                        <tr>
                            <td>
                                {{ arret.date_debut|date:"d/m/Y" }} ‚Üí 
                                {{ arret.date_fin_prevue|date:"d/m/Y" }}
                            </td>
                            <td>
                                {{ arret.duree_jours }} jour{{ arret.duree_jours|pluralize }}
                                {% if arret.est_long_terme %}
                                <span class="badge bg-warning">Long terme</span>
                                {% endif %}
                            </td>
                            <td>{{ arret.motif|default:"‚Äî" }}</td>
                            <td>
                                {% if arret.visite_reprise_requise %}
                                    {% if arret.visite_reprise_effectuee %}
                                    <span class="badge bg-success">Effectu√©e</span>
                                    {% else %}
                                    <span class="badge bg-warning">Requise</span>
                                    {% endif %}
                                {% else %}
                                ‚Äî
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Historique des certificats -->
    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-file-medical-fill me-2"></i>
                Historique des Visites M√©dicales
            </h5>
        </div>
        <div class="card-body">
            {% if historique_certificats %}
            <div class="timeline">
                {% for certificat in historique_certificats %}
                <div class="card mb-3 border-start border-5 border-{% if certificat.resultat == 'APTE' %}success{% else %}danger{% endif %}">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6>
                                    <span class="badge bg-{% if certificat.resultat == 'APTE' %}success{% else %}danger{% endif %}">
                                        {{ certificat.get_resultat_display }}
                                    </span>
                                    {{ certificat.date_visite|date:"d/m/Y" }}
                                </h6>
                                <p class="mb-1">
                                    <strong>Centre m√©dical :</strong> {{ certificat.organisme_medical }}
                                </p>
                                {% if certificat.resultat == 'APTE' and certificat.date_expiration_aptitude %}
                                <p class="mb-1">
                                    <strong>Validit√© :</strong> 
                                    {{ certificat.date_visite|date:"d/m/Y" }} ‚Üí {{ certificat.date_expiration_aptitude|date:"d/m/Y" }}
                                </p>
                                {% endif %}
                                {% if certificat.restrictions %}
                                <p class="mb-1 text-warning">
                                    <strong>Restrictions :</strong> {{ certificat.restrictions }}
                                </p>
                                {% endif %}
                                {% if certificat.commentaire %}
                                <p class="mb-0 text-muted">
                                    <em>{{ certificat.commentaire }}</em>
                                </p>
                                {% endif %}
                            </div>
                            <div class="col-md-4 text-end">
                                {% if certificat.piece_jointe %}
                                <a href="{{ certificat.piece_jointe.url }}" 
                                   class="btn btn-sm btn-outline-primary" 
                                   target="_blank">
                                    <i class="bi bi-download"></i> T√©l√©charger
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted">Aucun certificat m√©dical enregistr√©.</p>
            {% endif %}
        </div>
    </div>

</div>
{% endblock %}
