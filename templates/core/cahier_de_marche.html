<!-- Fichier : templates/core/cahier_de_marche.html (VERSION AVEC ÉVÉNEMENTS OUVERTS PAR DÉFAUT) -->
{% extends "base.html" %}
{% load static %}

{% block page_specific_styles %}
<link rel="stylesheet" href="{% static 'css/cahier_de_marche.css' %}">
{% endblock %}

{% block title %}Cahier de Marche - {{ centre.code_centre }} - {{ jour_selectionne|date:"d/m/Y" }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Cahier de Marche - {{ centre.nom_centre }}</h2>
        <h4>{{ jour_selectionne|date:"l d F Y" }}</h4>
    </div>

    <form class="mb-4 date-selector-form">
    <label for="date-selector" class="me-2">Changer de jour :</label>
    <input type="date" id="date-selector" class="form-control" value="{{ jour_selectionne|date:'Y-m-d' }}"
           data-base-url="{% url 'cahier-de-marche' centre_id=centre.id jour='__DATE__' %}">
    </form>

    <div class="row g-4">

        <!-- CARTE ÉVÉNEMENTS - OUVERTE PAR DÉFAUT -->
        <div class="col-12">
            <div class="card shadow-sm">
                <!-- NOTE : "aria-expanded=true" indique que la carte est ouverte -->
                <a href="#collapseEvenements" data-bs-toggle="collapse" class="card-header collapsible-header d-flex justify-content-between align-items-center" aria-expanded="true">
                    <h5 class="mb-0"><i class="bi bi-info-circle-fill text-primary me-2"></i>Événements</h5>
                    <i class="bi bi-chevron-down"></i>
                </a>
                <!-- NOTE : La classe "show" rend le contenu visible au chargement -->
                <div id="collapseEvenements" class="collapse show">
                    <div class="scrollable-card-content">
                        <div class="list-group list-group-flush">
                            {% for evt in evenements %}
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h5 class="mb-1">{{ evt.titre }}</h5>
                                        <small class="text-muted">{{ evt.date_heure_evenement|date:"H:i" }}</small>
                                    </div>
                                    <p class="mb-1">{{ evt.description }}</p>
                                    <small class="text-muted">Catégorie : {{ evt.categorie.nom }} | Par : {{ evt.auteur }}</small>
                                </div>
                            {% empty %}
                                 <div class="list-group-item text-muted">Aucun événement consigné pour ce jour.</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- COLONNE DE GAUCHE -->
        <div class="col-md-6 d-flex flex-column gap-4">
            
            <!-- CARTE HISTORIQUE SERVICE - FERMÉE PAR DÉFAUT -->
            <div class="card shadow-sm">
                <!-- NOTE : "aria-expanded=false" indique que la carte est fermée -->
                <a href="#collapseHistorique" data-bs-toggle="collapse" class="card-header collapsible-header d-flex justify-content-between align-items-center" aria-expanded="false">
                    <h5 class="mb-0"><i class="bi bi-clock-history text-info me-2"></i>Historique du Service</h5>
                    <i class="bi bi-chevron-down"></i>
                </a>
                <!-- NOTE : La classe "show" est ABSENTE, le contenu est donc caché -->
                <div id="collapseHistorique" class="collapse">
                    <div class="scrollable-card-content">
                        <ul class="list-group list-group-flush">
                            {% for item in historique_service %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        {% if item.type_action == 'OUVERTURE' %}<i class="bi bi-play-circle-fill text-success me-2"></i><strong>Ouverture</strong> par {{ item.agent_action }}{% endif %}
                                        {% if item.type_action == 'CLOTURE' %}<i class="bi bi-stop-circle-fill text-danger me-2"></i><strong>Clôture</strong> par {{ item.agent_action }}{% endif %}
                                        {% if item.type_action == 'REOUVERTURE' %}<i class="bi bi-arrow-counterclockwise text-warning me-2"></i><strong>Réouverture</strong> par {{ item.agent_action }}{% endif %}
                                    </div>
                                    <span class="badge bg-secondary rounded-pill">{{ item.timestamp|date:"H:i:s" }}</span>
                                </li>
                            {% empty %}
                                <li class="list-group-item text-muted">Service non ouvert pour ce jour.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- CARTE PANNES - FERMÉE PAR DÉFAUT -->
            <div class="card shadow-sm">
                <a href="#collapsePannes" data-bs-toggle="collapse" class="card-header collapsible-header d-flex justify-content-between align-items-center" aria-expanded="false">
                    <h5 class="mb-0"><i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>Pannes</h5>
                    <i class="bi bi-chevron-down"></i>
                </a>
                <div id="collapsePannes" class="collapse">
                    <div class="scrollable-card-content">
                        <div class="list-group list-group-flush">
                            {% for panne in pannes %}
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h5 class="mb-1">{{ panne.equipement_concerne }}</h5>
                                        <small>{% if panne.statut == 'EN_COURS' %}<span class="badge bg-danger">En cours</span>{% else %}<span class="badge bg-success">Résolue</span>{% endif %}</small>
                                    </div>
                                    <p class="mb-1">{{ panne.description }}</p>
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <small class="text-muted">Début : {{ panne.date_heure_debut|date:"d/m/Y H:i" }} | Par : {{ panne.auteur }}</small>
                                        {% if panne.statut == 'EN_COURS' and verrou_operationnel and verrou_operationnel.chef_de_quart == request.user.agent_profile and effective_perms.core.resolve_pannecentre %}
                                            <button class="btn btn-sm btn-success resolve-panne-btn" data-url="{% url 'resoudre-panne' centre_id=centre.id panne_id=panne.id %}" data-csrf="{{ csrf_token }}"><i class="bi bi-check-circle me-1"></i>Résoudre</button>
                                        {% endif %}
                                    </div>
                                </div>
                            {% empty %}
                                <div class="list-group-item text-muted">Aucune panne active pour ce jour.</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- COLONNE DE DROITE -->
        <div class="col-md-6 d-flex flex-column gap-4">
            
            <!-- CARTE MOUVEMENTS - FERMÉE PAR DÉFAUT -->
            <div class="card shadow-sm">
                <a href="#collapseMouvements" data-bs-toggle="collapse" class="card-header collapsible-header d-flex justify-content-between align-items-center" aria-expanded="false">
                    <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>Mouvements</h5>
                    <i class="bi bi-chevron-down"></i>
                </a>
                <div id="collapseMouvements" class="collapse">
                    <div class="scrollable-card-content">
                        <ul class="list-group list-group-flush">
                             {% for mouvement in mouvements %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        {% if mouvement.type == 'arrivee' %}<i class="bi bi-box-arrow-in-right text-success me-2"></i>{% else %}<i class="bi bi-box-arrow-left text-danger me-2"></i>{% endif %}
                                        {{ mouvement.agent }}
                                    </div>
                                    <span class="badge bg-secondary rounded-pill">{{ mouvement.timestamp|date:"H:i" }}</span>
                                </li>
                            {% empty %}
                                <li class="list-group-item text-muted">Aucun pointage pour ce jour.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- CARTE ACTIVITÉ DES ZONES - FERMÉE PAR DÉFAUT -->
            <div class="card shadow-sm">
                <a href="#collapseZones" data-bs-toggle="collapse" class="card-header collapsible-header d-flex justify-content-between align-items-center" aria-expanded="false">
                    <h5 class="mb-0"><i class="bi bi-geo-alt-fill text-purple me-2"></i>Activité des Zones</h5>
                    <i class="bi bi-chevron-down"></i>
                </a>
                <div id="collapseZones" class="collapse">
                    <div class="scrollable-card-content">
                        <ul class="list-group list-group-flush">
                            {% for activite in activites_zone %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        {% if activite.type_action == 'ACTIVATION' %}
                                            <i class="bi bi-toggle-on text-success me-2"></i><strong>Activation</strong>
                                        {% else %}
                                            <i class="bi bi-toggle-off text-danger me-2"></i><strong>Désactivation</strong>
                                        {% endif %}
                                        de la zone <strong>{{ activite.zone.nom }}</strong> par {{ activite.agent_action }}
                                    </div>
                                    <span class="badge bg-secondary rounded-pill">{{ activite.timestamp|date:"H:i:s" }}</span>
                                </li>
                            {% empty %}
                                <li class="list-group-item text-muted">Aucune activité de zone enregistrée pour ce jour.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>

        </div>
    </div> <!-- Fin de la div.row -->
</div> <!-- Fin de la div.container -->
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script src="{% static 'js/cahier_de_marche.js' %}"></script>
    <script src="{% static 'js/date_selector.js' %}"></script>
{% endblock scripts %}