<!-- Fichier : templates/core/cahier_de_marche.html (VERSION AVEC MISE EN PAGE EN GRILLE) -->
{% extends "base.html" %}
{% load static %}

{% block title %}Cahier de Marche - {{ centre.code_centre }} - {{ jour_selectionne|date:"d/m/Y" }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Cahier de Marche - {{ centre.nom_centre }}</h2>
        <h4>{{ jour_selectionne|date:"l d F Y" }}</h4>
    </div>

    <!-- MODIFICATION : Ajout d'une classe au formulaire pour le cibler en CSS -->
    <form class="mb-4 date-selector-form" method="get" action="{% url 'cahier-de-marche' centre_id=centre.id jour='__DATE__' %}">
        <label for="date-selector" class="me-2">Changer de jour :</label>
        <input type="date" id="date-selector" class="form-control" value="{{ jour_selectionne|date:'Y-m-d' }}">
        <script>
            document.getElementById('date-selector').addEventListener('change', function() {
                let newDate = this.value;
                if (newDate) {
                    let url = "{% url 'cahier-de-marche' centre_id=centre.id jour='__DATE__' %}".replace('__DATE__', newDate);
                    window.location.href = url;
                }
            });
        </script>
    </form>

    <!-- ============================================================================== -->
    <!-- DÉBUT DE LA NOUVELLE STRUCTURE EN GRILLE                                     -->
    <!-- ============================================================================== -->
    <div class="row g-4">  <!-- g-4 ajoute un espacement entre les colonnes -->

        <!-- PREMIÈRE LIGNE : Historique et Mouvements -->
        <div class="col-md-6">
            <div class="card h-100-flex shadow-sm">
                <div class="card-header"><h5 class="mb-0"><i class="bi bi-clock-history text-info me-2"></i>Historique du Service</h5></div>
                <ul class="list-group list-group-flush" id="historique-service-list">
                    {% for item in historique_service %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                {% if item.type_action == 'OUVERTURE' %}<i class="bi bi-play-circle-fill text-success me-2"></i><strong>Ouverture</strong> par {{ item.agent_action }}{% endif %}
                                {% if item.type_action == 'CLOTURE' %}<i class="bi bi-stop-circle-fill text-danger me-2"></i><strong>Clôture</strong> par {{ item.agent_action }}{% endif %}
                                {% if item.type_action == 'REOUVERTURE' %}<i class="bi bi-arrow-counterclockwise text-warning me-2"></i><strong>Réouverture</strong> par {{ item.agent_action }}{% endif %}
                            </div>
                            <span class="badge bg-secondary rounded-pill">{{ item.timestamp|date:"H:i:s" }}</span>
                        </li>
                    {% empty %}
                        <li class="list-group-item text-muted">Service non ouvert pour ce jour.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100-flex shadow-sm">
                <div class="card-header"><h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>Mouvements</h5></div>
                <ul class="list-group list-group-flush">
                     {% for mouvement in mouvements %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                {% if mouvement.type == 'arrivee' %}<i class="bi bi-box-arrow-in-right text-success me-2"></i>{% else %}<i class="bi bi-box-arrow-left text-danger me-2"></i>{% endif %}
                                {{ mouvement.agent }}
                            </div>
                            <span class="badge bg-secondary rounded-pill">{{ mouvement.timestamp|date:"H:i" }}</span>
                        </li>
                    {% empty %}
                        <li class="list-group-item text-muted">Aucun pointage pour ce jour.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <!-- DEUXIÈME LIGNE : Pannes et Événements -->
        <div class="col-md-6 mt-4">
            <div class="card h-100-flex shadow-sm">
                <div class="card-header"><h5 class="mb-0"><i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>Pannes</h5></div>
                <div class="list-group list-group-flush">
                    {% for panne in pannes %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">{{ panne.equipement_concerne }}</h5>
                                <small>{% if panne.statut == 'EN_COURS' %}<span class="badge bg-danger">En cours</span>{% else %}<span class="badge bg-success">Résolue</span>{% endif %}</small>
                            </div>
                            <p class="mb-1">{{ panne.description }}</p>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <small class="text-muted">Début : {{ panne.date_heure_debut|date:"d/m/Y H:i" }} | Par : {{ panne.auteur }}</small>
                                {% if panne.statut == 'EN_COURS' and verrou_operationnel and verrou_operationnel.chef_de_quart == request.user.agent_profile and effective_perms.core.resolve_pannecentre %}
                                    <button class="btn btn-sm btn-success resolve-panne-btn" data-url="{% url 'resoudre-panne' centre_id=centre.id panne_id=panne.id %}" data-csrf="{{ csrf_token }}"><i class="bi bi-check-circle me-1"></i>Résoudre</button>
                                {% endif %}
                            </div>
                        </div>
                    {% empty %}
                        <div class="list-group-item text-muted">Aucune panne active pour ce jour.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-md-6 mt-4">
            <div class="card h-100-flex shadow-sm">
                <div class="card-header"><h5 class="mb-0"><i class="bi bi-info-circle-fill text-primary me-2"></i>Événements</h5></div>
                <div class="list-group list-group-flush">
                    {% for evt in evenements %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">{{ evt.titre }}</h5>
                                <small class="text-muted">{{ evt.date_heure_evenement|date:"H:i" }}</small>
                            </div>
                            <p class="mb-1">{{ evt.description }}</p>
                            <small class="text-muted">Catégorie : {{ evt.categorie.nom }} | Par : {{ evt.auteur }}</small>
                        </div>
                    {% empty %}
                         <div class="list-group-item text-muted">Aucun événement consigné pour ce jour.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <!-- ============================================================================== -->
    <!-- FIN DE LA NOUVELLE STRUCTURE EN GRILLE                                       -->
    <!-- ============================================================================== -->
</div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script src="{% static 'js/cahier_de_marche.js' %}"></script>
{% endblock scripts %}