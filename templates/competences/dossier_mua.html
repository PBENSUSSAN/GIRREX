<!-- Fichier : templates/competences/dossier_mua.html -->
{% extends "base.html" %}

{% block title %}{{ titre }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'competences:tableau_bord' %}">Tableau de Bord</a></li>
            <li class="breadcrumb-item"><a href="{% url 'competences:dossier_agent' agent_concerne.id_agent %}">Dossier {{ agent_concerne.trigram }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">Dossier MUA {{ mua.get_type_flux_display }}</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mt-3">
        <h3>{{ titre }}</h3>
        <span class="text-muted">Cycle du {{ mua.date_debut_cycle|date:"d/m/Y" }} au {{ mua.date_fin_cycle|date:"d/m/Y" }}</span>
    </div>
    <hr>

    <div class="row g-4">
        <!-- ============================================= -->
        <!--            COLONNE DE GAUCHE : PILOTAGE         -->
        <!-- ============================================= -->
        <div class="col-lg-8 d-flex flex-column gap-4">

            <!-- Carte des Objectifs de Renouvellement -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5><i class="bi bi-bar-chart-line-fill me-2"></i>Objectifs de Renouvellement</h5>
                </div>
                <div class="card-body">
                    {% for barre in barres_progression %}
                        {% if barre.est_objectif %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <strong>{{ barre.nom }}</strong>
                                <span>{% if barre.valide %}✅{% else %}❌{% endif %} {{ barre.effectue|floatformat:2 }} / {{ barre.requis }} h</span>
                            </div>
                            <div class="progress" style="height: 20px;" title="{{ barre.nom }} : {{ barre.effectue|floatformat:2 }} / {{ barre.requis }} heures">
                                <div class="progress-bar {% if not barre.valide %}bg-warning{% endif %}" role="progressbar" 
                                     style="width: {{ barre.pourcentage }}%;" aria-valuenow="{{ barre.pourcentage }}">
                                     {{ barre.pourcentage }}%
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% empty %}
                        <p class="text-muted">Aucune règle de renouvellement d'heures n'est configurée.</p>
                    {% endfor %}
                </div>
            </div>
            
        </div>

        <!-- ============================================= -->
        <!--         COLONNE DE DROITE : SYNTHÈSE & ACTIONS  -->
        <!-- ============================================= -->
        <div class="col-lg-4 d-flex flex-column gap-4">
            
            <!-- Carte du Socle de Validité -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5><i class="bi bi-shield-check me-2"></i>Socle de Validité</h5>
                </div>
                <ul class="list-group list-group-flush">
                    {% for item in checklist_socle %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <strong>{{ item.nom }}</strong>
                        {% if item.valide %}
                            <span class="badge bg-success">Valide</span>
                        {% else %}
                            <span class="badge bg-danger" title="{{ item.details }}">Manquant ou expiré</span>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <!-- Carte des Heures de Rôles Spécifiques -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5><i class="bi bi-people-fill me-2"></i>Compteurs de Rôles</h5>
                </div>
                <div class="card-body">
                     {% for barre in barres_progression %}
                        {% if not barre.est_objectif %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <strong>{{ barre.nom }}</strong>
                                <span>{{ barre.effectue|floatformat:2 }} / {{ barre.requis }} h</span>
                            </div>
                            <div class="progress" style="height: 20px;" title="{{ barre.nom }} : {{ barre.effectue|floatformat:2 }} / {{ barre.requis }} heures (plafond)">
                                <div class="progress-bar bg-info" role="progressbar" 
                                     style="width: {{ barre.pourcentage }}%;" aria-valuenow="{{ barre.pourcentage }}">
                                     {{ barre.effectue|floatformat:2 }}h
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            <!-- Carte d'Actions -->
             <div class="card shadow-sm">
                <div class="card-header">
                    <h5><i class="bi bi-check2-circle me-2"></i>Actions</h5>
                </div>
                <div class="card-body d-grid gap-2">
                    <a href="{% url 'competences:releve_mensuel_mua' mua.id %}" class="btn btn-info">
                        <i class="bi bi-calendar3 me-2"></i>Voir le Relevé Mensuel Détaillé
                    </a>
                    <hr class="my-1">
                    {% if toutes_conditions_remplies %}
                        <button class="btn btn-primary">Valider le Renouvellement</button>
                    {% else %}
                        <button class="btn btn-secondary" disabled>Conditions non remplies</button>
                    {% endif %}
                    <button class="btn btn-outline-secondary" disabled>Exporter la Synthèse (PDF)</button>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}