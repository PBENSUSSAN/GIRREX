<!-- Fichier : templates/partials/sidebar_menu.html (Version Corrigée et Optimisée) -->

<ul class="list-unstyled components">
    
    <!-- ========================================================== -->
    <!--            BLOC 1 : VUES SPÉCIFIQUES AU RÔLE               -->
    <!-- ========================================================== -->

    <!-- Vue Supervision Nationale -->
    {% if is_supervisor_view %}
        <li><a href="{% url 'selecteur-centre' %}?next_view=tour-de-service-centre"><i class="bi bi-calendar-week"></i>Tour de Service (Supervision)</a></li>
        <li><a href="{% url 'selecteur-centre' %}?next_view=cahier-de-marche"><i class="bi bi-book"></i>Cahier de Marche (Supervision)</a></li>
    {% endif %}

    <!-- Vue Opérationnelle de Centre -->
    {% if show_operational_view and centre_agent %}
        <li><a href="{% url 'tour-de-service-centre' centre_agent.id %}"><i class="bi bi-calendar-week"></i>Tour de Service</a></li>
        <li class="nav-item">
            <a class="nav-link collapsed d-flex justify-content-between align-items-center" href="#" data-bs-toggle="collapse" data-bs-target="#collapseCahierDeMarche" aria-expanded="false">
                <div><i class="bi bi-book"></i><span>Cahier de Marche</span></div>
                <i class="bi bi-chevron-right sidebar-chevron"></i>
            </a>
            <ul class="collapse list-unstyled" id="collapseCahierDeMarche">
                <li class="sidebar-submenu-header">Actions du Service</li>
                {% if not service_du_jour %}
                    {% if effective_perms.core.open_close_service %}
                        <li><form action="{% url 'gerer-service' centre_agent.id 'ouvrir' %}" method="post" class="ps-4">{% csrf_token %}<button type="submit" class="btn btn-link nav-link text-primary fw-bold p-0"><i class="bi bi-play-circle-fill me-1"></i>Ouvrir le Service</button></form></li>
                    {% endif %}
                {% elif service_du_jour.statut == 'OUVERTE' %}
                    {% if verrou_operationnel and verrou_operationnel.chef_de_quart == user.agent_profile %}
                        {% if effective_perms.core.open_close_service %}
                            <li><form action="{% url 'gerer-service' centre_agent.id 'cloturer' %}" method="post" class="ps-4">{% csrf_token %}<button type="submit" class="btn btn-link nav-link text-danger fw-bold p-0"><i class="bi bi-stop-circle-fill me-1"></i>Fermer le Service</button></form></li>
                        {% endif %}
                    {% else %}
                        {% if effective_perms.core.change_feuilletemps %}
                            <li><form action="{% url 'gerer-service' centre_agent.id 'forcer-prise' %}" method="post" class="ps-4" title="Service pris par {{ verrou_operationnel.chef_de_quart }}. Cliquez pour forcer.">{% csrf_token %}<button type="submit" class="btn btn-link nav-link text-warning fw-bold p-0"><i class="bi bi-shield-lock-fill me-1"></i>Forcer la Prise</button></form></li>
                        {% else %}
                            <li><span class="ps-4 disabled" title="Le service est actuellement pris par {{ verrou_operationnel.chef_de_quart }}.">Service Pris</span></li>
                        {% endif %}
                    {% endif %}
                {% elif service_du_jour.statut == 'CLOTUREE' %}
                    {% if effective_perms.core.reopen_service %}
                        <li><form action="{% url 'gerer-service' centre_agent.id 'reouvrir' %}" method="post" class="ps-4">{% csrf_token %}<button type="submit" class="btn btn-link nav-link text-warning fw-bold p-0"><i class="bi bi-arrow-counterclockwise me-1"></i>Rouvrir le Service</button></form></li>
                    {% else %}
                        <li><span class="ps-4 disabled">Service Clôturé</span></li>
                    {% endif %}
                {% elif service_du_jour.statut == 'VISEE' %}
                    <li><span class="ps-4 disabled text-success"><i class="bi bi-patch-check-fill me-1"></i>Service Visé</span></li>
                {% endif %}
                <li class="sidebar-submenu-header">Saisie & Modification</li>
                {% if service_du_jour and service_du_jour.statut == 'OUVERTE' and verrou_operationnel and verrou_operationnel.chef_de_quart == request.user.agent_profile %}
                    <li><a href="{% url 'feuille-temps-specific-jour' centre_agent.id today|date:'Y-m-d' %}" class="ps-4">Feuille d'heure</a></li>
                    <li><a href="{% url 'activites:saisie_jour' centre_agent.id today|date:'Y-m-d' %}" class="ps-4 fw-bold text-primary">Saisie des Activités de Vol</a></li>
                    <li><a href="{% url 'ajouter-panne' centre_agent.id %}" class="ps-4">Signaler une Panne</a></li>
                    <li><a href="{% url 'ajouter-evenement' centre_agent.id %}" class="ps-4">Consigner un Événement</a></li>
                    <li><a href="{% url 'qs:pre-declarer-fne' centre_agent.id %}" class="ps-4 text-warning fw-bold">Signaler un Événement QS</a></li>
                    <li><a href="{% url 'gestion-zone' centre_agent.id %}" class="ps-4">Gestion Zone</a></li>
                {% else %}
                    <li><span class="ps-4 disabled" title="Vous devez ouvrir le service et en avoir le contrôle.">Feuille d'heure</span></li>
                    <li><span class="ps-4 disabled" title="Vous devez ouvrir le service et en avoir le contrôle.">Saisie des Activités de Vol</span></li>
                    <li><span class="ps-4 disabled" title="Vous devez ouvrir le service et en avoir le contrôle.">Signaler une Panne</span></li>
                    <li><span class="ps-4 disabled" title="Vous devez ouvrir le service et en avoir le contrôle.">Consigner un Événement</span></li>
                    <li><span class="ps-4 disabled" title="Vous devez ouvrir le service et en avoir le contrôle.">Signaler un Événement QS</span></li>
                    <li><span class="ps-4 disabled" title="Vous devez ouvrir le service et en avoir le contrôle.">Gestion Zone</span></li>
                {% endif %}
                <li class="sidebar-submenu-header">Consultation</li>
                <li><a href="{% url 'cahier-de-marche' centre_agent.id today|date:'Y-m-d' %}" class="ps-4">Chronologie du Jour</a></li>
            </ul>
        </li>
    {% endif %}

    <!-- ========================================================== -->
    <!--            BLOC 1.5 : MENU DE PLANIFICATION CCA          -->
    <!-- ========================================================== -->
    {% if is_supervisor_view %} {# Le menu s'affiche pour les rôles de supervision #}
    <li class="nav-item">
        <a class="nav-link collapsed d-flex justify-content-between align-items-center" href="#collapseCCA" data-bs-toggle="collapse" aria-expanded="false">
            <div><i class="bi bi-calendar2-week"></i><span>Planification CCA</span></div>
            <i class="bi bi-chevron-right sidebar-chevron"></i>
        </a>
        <ul class="collapse list-unstyled" id="collapseCCA">
            <li class="sidebar-submenu-header">Planification</li>
            <li>
                <a href="{% url 'activites:cca_planning' next_day_str %}" class="ps-4">Planning J+1</a>
            </li>
             <li class="sidebar-submenu-header">Suivi</li>
            <li>
                <a href="{% url 'activites:cca_supervision' %}" class="ps-4">Supervision Jour J</a>
            </li>
        </ul>
    </li>
    {% endif %}

    <!-- ========================================================== -->
    <!--            BLOC 2 : MENUS DE GESTION DE DOMAINE            -->
    <!-- ========================================================== -->
    
    {% if show_sms_menu %}
    <li class="nav-item">
        <a class="nav-link collapsed d-flex justify-content-between align-items-center" href="#collapseSms" data-bs-toggle="collapse" aria-expanded="false">
            <div><i class="bi bi-shield-shaded"></i><span>SMS</span></div><i class="bi bi-chevron-right sidebar-chevron"></i>
        </a><ul class="collapse list-unstyled" id="collapseSms"><li><a href="{% url 'documentation:liste-documents' %}" class="ps-4">Documentation</a></li></ul>
    </li>
    {% endif %}

    {% if show_aptitudes_menu %}
    <li class="nav-item">
        {# On renomme le menu en "Aptitudes" et on change la cible du collapse #}
        <a class="nav-link collapsed d-flex justify-content-between align-items-center" href="#collapseAptitudes" data-bs-toggle="collapse" aria-expanded="false">
            <div><i class="bi bi-person-check-fill"></i><span>Aptitudes</span></div>
            <i class="bi bi-chevron-right sidebar-chevron"></i>
        </a>
        {# On crée la nouvelle structure de sous-menus #}
        <ul class="collapse list-unstyled" id="collapseAptitudes">
            <li class="sidebar-submenu-header">Suivi des Compétences</li>
            <li>
                <a href="{% url 'competences:tableau_bord' %}" class="ps-4">Tableau de Bord de Suivi</a>
            </li>
            {% if request.user.agent_profile.centre %}
            <li>
              <a href="{% url 'competences:dossier_agent' request.user.agent_profile.id_agent %}" class="ps-4">Mon Dossier Personnel</a>
            </li>
            {% endif %}

            {% if effective_perms.competences.view_all_licences %}
            <li class="sidebar-submenu-header">Supervision & Audit</li>
            <li>
                <a href="{% url 'competences:journal_audit' %}" class="ps-4">
                    <i class="bi bi-clipboard2-pulse-fill"></i> Journal d'Audit Système
                </a>
            </li>
            {% endif %}

            {# NOUVELLE SECTION : SUIVI MÉDICAL #}
            <li class="sidebar-submenu-header">Suivi Médical</li>
            
            {# Tous les agents voient leur propre dossier #}
            {% if request.user.agent_profile %}
            <li>
                <a href="{% url 'dossier_medical' request.user.agent_profile.id_agent %}" class="ps-4">
                    <i class="bi bi-heart-pulse-fill"></i> Mon Dossier Médical
                </a>
            </li>
            {% endif %}
            
            {# Dashboard Médical Centre / National #}
            {# On affiche le menu pour tous les rôles autorisés #}
            {% if request.user.agent_profile %}
                {% if effective_perms.competences.change_licence or effective_perms.competences.view_all_licences or active_agent_role.role.nom == ROLES.CHEF_DE_CENTRE or active_agent_role.role.nom == ROLES.ADJOINT_CHEF_DE_CENTRE or active_agent_role.role.nom == ROLES.CHEF_DE_DIVISION or active_agent_role.role.nom == ROLES.ADJOINT_CHEF_DE_DIVISION or active_agent_role.role.nom == ROLES.ADJOINT_FORM or active_agent_role.role.nom == ROLES.FORM_LOCAL %}
                <li>
                    {% if request.user.agent_profile.centre %}
                    <a href="{% url 'dashboard_medical_centre' request.user.agent_profile.centre.id %}" class="ps-4">
                        <i class="bi bi-hospital-fill"></i> Dashboard Médical Centre
                    </a>
                    {% else %}
                    <a href="{% url 'dashboard_medical_national' %}" class="ps-4">
                        <i class="bi bi-hospital-fill"></i> Dashboard Médical National
                    </a>
                    {% endif %}
                </li>
                {% endif %}
            {% endif %}

            <li class="sidebar-submenu-header">Gestion de la Formation</li>
            <li>
                <a href="#" class="ps-4 disabled">Catalogue des Formations</a>
            </li>
            <li>
                <a href="#" class="ps-4 disabled">Plan de Formation</a>
            </li>
        </ul>
    </li>
    {% endif %}

    {% if show_technique_menu %}
    <li class="nav-item">
        <a class="nav-link collapsed d-flex justify-content-between align-items-center" href="#collapseTechnique" data-bs-toggle="collapse" aria-expanded="false">
            <div><i class="bi bi-tools"></i><span>Technique</span></div><i class="bi bi-chevron-right sidebar-chevron"></i>
        </a>
        <ul class="collapse list-unstyled" id="collapseTechnique">
            <li><a href="{% url 'technique:liste-miso' %}" class="ps-4">MISO</a></li>
            <li><a href="{% url 'technique:liste-pannes' %}" class="ps-4">Pannes</a></li>
        </ul>
    </li>
    {% endif %}

    {% if show_technique_menu %}
    <li class="nav-item">
        <a class="nav-link collapsed d-flex justify-content-between align-items-center" href="#collapseEs" data-bs-toggle="collapse" aria-expanded="false">
            <div><i class="bi bi-shield-check"></i><span>Études de Sécurité</span></div><i class="bi bi-chevron-right sidebar-chevron"></i>
        </a>
        <ul class="collapse list-unstyled" id="collapseEs">
            <li><a href="{% url 'es:tableau-etudes' %}" class="ps-4">Tableau de Bord ES</a></li>
            <li><a href="{% url 'es:liste-changements' %}" class="ps-4">Changements à Classifier</a></li>
        </ul>
    </li>
    {% endif %}

    {% if show_security_menu %}
    <li class="nav-item">
        <a class="nav-link collapsed d-flex justify-content-between align-items-center" href="#collapseSecu" data-bs-toggle="collapse" aria-expanded="false">
            <div><i class="bi bi-shield-check"></i><span>Sécurité aérienne</span></div><i class="bi bi-chevron-right sidebar-chevron"></i>
        </a>
        <ul class="collapse list-unstyled" id="collapseSecu">
            <li><a href="{% url 'qs:tableau-bord-qs' %}" class="ps-4">Tableau des FNE</a></li>
        </ul>
    </li>
    {% endif %}

    {% if show_cyber_menu %}
    <li class="nav-item">
        <a class="nav-link collapsed d-flex justify-content-between align-items-center" href="#collapseCyber" data-bs-toggle="collapse" aria-expanded="false">
            <div><i class="bi bi-shield-lock"></i><span>Cybersécurité SMSI</span></div>
            <i class="bi bi-chevron-right sidebar-chevron"></i>
        </a>
        <ul class="collapse list-unstyled" id="collapseCyber">
            {% if is_smsi_central_view %}
                <li><a href="{% url 'cyber:dashboard' %}" class="ps-4">Tableau de Bord National</a></li>
            {% endif %}
            {% if is_relais_local_view and centre_agent %}
                <li><a href="{% url 'cyber:smsi-detail' centre_agent.id %}" class="ps-4">Pilotage SMSI [{{ centre_agent.code_centre }}]</a></li>
            {% endif %}
        </ul>
    </li>
    {% endif %}

    <!-- ========================================================== -->
    <!--               BLOC 3 : LIENS UNIVERSELS                  -->
    <!-- ========================================================== -->
    <hr>
    
    <!-- Lien pour déclarer un événement QS (pour les utilisateurs locaux) -->
    {% if user.is_authenticated and user.agent_profile.centre %}
        <li>
            <a href="{% url 'qs:pre-declarer-fne' user.agent_profile.centre.id %}" class="text-warning">
                <i class="bi bi-shield-exclamation"></i>Déclarer un Événement QS
            </a>
        </li>
    {% endif %}

    <!-- Lien pour soumettre un feedback (pour tous les utilisateurs) -->
    {% if user.is_authenticated and user.agent_profile %}
    <li>
        <a href="{% url 'feedback:soumettre' %}" class="text-info">
            <i class="bi bi-chat-left-text-fill"></i>Faire une suggestion
        </a>
    </li>
    {% endif %}

    <!-- Lien vers le tableau de suivi (pour tous les utilisateurs) -->
    <li><a href="{% url 'suivi:tableau-actions' %}"><i class="bi bi-clipboard2-data-fill"></i>Tableau de Suivi</a></li>
    
    <hr>
    
        <!-- ========================================================== -->
    <!--            BLOC 4 : MENU MANAGEMENT DE CENTRE              -->
    <!-- ========================================================== -->
    {% if active_agent_role.role.nom == ROLES.CHEF_DE_CENTRE or active_agent_role.role.nom == ROLES.ADJOINT_CHEF_DE_CENTRE %}
    <li>
        <a href="#managementSubmenu" data-bs-toggle="collapse" aria-expanded="false" class="dropdown-toggle"><i class="bi bi-building-gear"></i>Management Centre</a>
        <ul class="collapse list-unstyled" id="managementSubmenu">
            
            <!-- Lien pour la gestion de la capacité du centre local -->
            {% if effective_perms.core.change_centre and request.user.agent_profile.centre %}
            <li>
                <a href="{% url 'gestion_capacite' request.user.agent_profile.centre.id %}" class="ps-4">
                    <i class="bi bi-sliders"></i> Gestion Capacité
                </a>
            </li>
            {% endif %}

            <li><a href="#" class="ps-4 disabled">Gestion des Agents</a></li>
        </ul>
    </li>
    {% endif %}

    <!-- ========================================================== -->
    <!--            BLOC 5 : MENU ADMINISTRATION TECHNIQUE          -->
    <!-- ========================================================== -->
    {% if user.is_superuser %}
    <li>
        <a href="#adminSubmenu" data-bs-toggle="collapse" aria-expanded="false" class="dropdown-toggle"><i class="bi bi-gear-fill"></i>Administration Tech</a>
        <ul class="collapse list-unstyled" id="adminSubmenu">
            <li><a href="{% url 'admin:index' %}" class="ps-4">Interface Admin Django</a></li>
            
            {% if effective_perms.feedback.view_feedback_dashboard %}
            <li>
                <a href="{% url 'feedback:tableau-de-bord' %}" class="ps-4">
                    <i class="bi bi-mailbox"></i> Retours Utilisateurs
                </a>
            </li>
            {% endif %}
            
            <li><a href="#" class="ps-4 disabled">Paramètres Généraux</a></li>
        </ul>
    </li>
    {% endif %}
</ul>