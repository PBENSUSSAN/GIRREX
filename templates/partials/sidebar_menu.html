<!-- Fichier : templates/partials/sidebar_menu.html (Version Finale Complète et Corrigée) -->

<ul class="list-unstyled components">
    
    <!-- BLOC 1 : VUE SUPERVISION NATIONALE -->
    {% if is_supervisor_view %}
        <li><a href="{% url 'selecteur-centre' %}?next_view=tour-de-service-centre"><i class="bi bi-calendar-week"></i>Tour de Service (Supervision)</a></li>
        <li><a href="{% url 'selecteur-centre' %}?next_view=cahier-de-marche"><i class="bi bi-book"></i>Cahier de Marche (Supervision)</a></li>
    {% endif %}

    <!-- BLOC 2 : VUE OPÉRATIONNELLE DE CENTRE -->
    {% if show_operational_view and centre_agent %}
        <li><a href="{% url 'tour-de-service-centre' centre_agent.id %}"><i class="bi bi-calendar-week"></i>Tour de Service</a></li>
        <li class="nav-item">
            <a class="nav-link collapsed d-flex justify-content-between align-items-center" href="#" data-bs-toggle="collapse" data-bs-target="#collapseCahierDeMarche" aria-expanded="false">
                <div><i class="bi bi-book"></i><span>Cahier de Marche</span></div>
                <i class="bi bi-chevron-right sidebar-chevron"></i>
            </a>
            <ul class="collapse list-unstyled" id="collapseCahierDeMarche">
                <li class="sidebar-submenu-header">Actions du Service</li>
                {% if not service_du_jour %}
                    {% if effective_perms.core.open_close_service %}
                        <li><form action="{% url 'gerer-service' centre_agent.id 'ouvrir' %}" method="post" class="ps-4">{% csrf_token %}<button type="submit" class="btn btn-link nav-link text-primary fw-bold p-0"><i class="bi bi-play-circle-fill me-1"></i>Ouvrir le Service</button></form></li>
                    {% endif %}
                {% elif service_du_jour.statut == 'OUVERTE' %}
                    {% if verrou_operationnel and verrou_operationnel.chef_de_quart == user.agent_profile %}
                        {% if effective_perms.core.open_close_service %}
                            <li><form action="{% url 'gerer-service' centre_agent.id 'cloturer' %}" method="post" class="ps-4">{% csrf_token %}<button type="submit" class="btn btn-link nav-link text-danger fw-bold p-0"><i class="bi bi-stop-circle-fill me-1"></i>Fermer le Service</button></form></li>
                        {% endif %}
                    {% else %}
                        {% if effective_perms.core.change_feuilletemps %}
                            <li><form action="{% url 'gerer-service' centre_agent.id 'forcer-prise' %}" method="post" class="ps-4" title="Service pris par {{ verrou_operationnel.chef_de_quart }}. Cliquez pour forcer.">{% csrf_token %}<button type="submit" class="btn btn-link nav-link text-warning fw-bold p-0"><i class="bi bi-shield-lock-fill me-1"></i>Forcer la Prise</button></form></li>
                        {% else %}
                            <li><span class="ps-4 disabled" title="Le service est actuellement pris par {{ verrou_operationnel.chef_de_quart }}.">Service Pris</span></li>
                        {% endif %}
                    {% endif %}
                {% elif service_du_jour.statut == 'CLOTUREE' %}
                    {% if effective_perms.core.reopen_service %}
                        <li><form action="{% url 'gerer-service' centre_agent.id 'reouvrir' %}" method="post" class="ps-4">{% csrf_token %}<button type="submit" class="btn btn-link nav-link text-warning fw-bold p-0"><i class="bi bi-arrow-counterclockwise me-1"></i>Rouvrir le Service</button></form></li>
                    {% else %}
                        <li><span class="ps-4 disabled">Service Clôturé</span></li>
                    {% endif %}
                {% elif service_du_jour.statut == 'VISEE' %}
                    <li><span class="ps-4 disabled text-success"><i class="bi bi-patch-check-fill me-1"></i>Service Visé</span></li>
                {% endif %}
                <li class="sidebar-submenu-header">Saisie & Modification</li>
                {% if service_du_jour and service_du_jour.statut == 'OUVERTE' and verrou_operationnel and verrou_operationnel.chef_de_quart == request.user.agent_profile %}
                    <li><a href="{% url 'feuille-temps-specific-jour' centre_agent.id today|date:'Y-m-d' %}" class="ps-4">Feuille d'heure</a></li>
                    <li><a href="{% url 'ajouter-panne' centre_agent.id %}" class="ps-4">Signaler une Panne</a></li>
                    <li><a href="{% url 'ajouter-evenement' centre_agent.id %}" class="ps-4">Consigner un Événement</a></li>
                    <!-- RÉINTÉGRATION DU LIEN CONTEXTUEL POUR LE CDQ -->
                    <li><a href="{% url 'qs:pre-declarer-fne' centre_agent.id %}" class="ps-4 text-warning fw-bold">Signaler un Événement QS</a></li>
                    <li><a href="{% url 'gestion-zone' centre_agent.id %}" class="ps-4">Gestion Zone</a></li>
                {% else %}
                    <li><span class="ps-4 disabled" title="Vous devez ouvrir le service et en avoir le contrôle.">Feuille d'heure</span></li>
                    <li><span class="ps-4 disabled" title="Vous devez ouvrir le service et en avoir le contrôle.">Signaler une Panne</span></li>
                    <li><span class="ps-4 disabled" title="Vous devez ouvrir le service et en avoir le contrôle.">Consigner un Événement</span></li>
                    <!-- RÉINTÉGRATION DU LIEN CONTEXTUEL (désactivé) -->
                    <li><span class="ps-4 disabled" title="Vous devez ouvrir le service et en avoir le contrôle.">Signaler un Événement QS</span></li>
                    <li><span class="ps-4 disabled" title="Vous devez ouvrir le service et en avoir le contrôle.">Gestion Zone</span></li>
                {% endif %}
                <li class="sidebar-submenu-header">Consultation</li>
                <li><a href="{% url 'cahier-de-marche' centre_agent.id today|date:'Y-m-d' %}" class="ps-4">Chronologie du Jour</a></li>
            </ul>
        </li>
    {% endif %}

    <!-- BLOC 3 : MENUS DE GESTION DE DOMAINE -->
    {% if show_sms_menu %}
    <li class="nav-item">
        <a class="nav-link collapsed d-flex justify-content-between align-items-center" href="#collapseSms" data-bs-toggle="collapse" aria-expanded="false">
            <div><i class="bi bi-shield-shaded"></i><span>SMS</span></div><i class="bi bi-chevron-right sidebar-chevron"></i>
        </a><ul class="collapse list-unstyled" id="collapseSms"><li><a href="{% url 'documentation:liste-documents' %}" class="ps-4">Documentation</a></li></ul>
    </li>
    {% endif %}

    {% if show_formation_menu %}
    <li class="nav-item">
        <a class="nav-link collapsed d-flex justify-content-between align-items-center" href="#collapseFormation" data-bs-toggle="collapse" aria-expanded="false">
            <div><i class="bi bi-mortarboard-fill"></i><span>Formation</span></div><i class="bi bi-chevron-right sidebar-chevron"></i>
        </a><ul class="collapse list-unstyled" id="collapseFormation"><li><a href="#" class="ps-4">Agents</a></li></ul>
    </li>
    {% endif %}

    {% if show_technique_menu %}
    <li class="nav-item">
        <a class="nav-link collapsed d-flex justify-content-between align-items-center" href="#collapseTechnique" data-bs-toggle="collapse" aria-expanded="false">
            <div><i class="bi bi-tools"></i><span>Technique</span></div><i class="bi bi-chevron-right sidebar-chevron"></i>
        </a>
        <ul class="collapse list-unstyled" id="collapseTechnique">
            <li><a href="{% url 'technique:liste-miso' %}" class="ps-4">MISO</a></li>
            <li><a href="{% url 'technique:liste-pannes' %}" class="ps-4">Pannes</a></li>
        </ul>
    </li>
    {% endif %}

    {% if show_technique_menu %}
    <li class="nav-item">
        <a class="nav-link collapsed d-flex justify-content-between align-items-center" href="#collapseEs" data-bs-toggle="collapse" aria-expanded="false">
            <div><i class="bi bi-shield-check"></i><span>Études de Sécurité</span></div><i class="bi bi-chevron-right sidebar-chevron"></i>
        </a>
        <ul class="collapse list-unstyled" id="collapseEs">
            <li><a href="{% url 'es:tableau-etudes' %}" class="ps-4">Tableau de Bord ES</a></li>
            <li><a href="{% url 'es:liste-changements' %}" class="ps-4">Changements à Classifier</a></li>
        </ul>
    </li>
    {% endif %}

    {% if show_security_menu %}
    <li class="nav-item">
        <a class="nav-link collapsed d-flex justify-content-between align-items-center" href="#collapseSecu" data-bs-toggle="collapse" aria-expanded="false">
            <div><i class="bi bi-shield-check"></i><span>Sécurité aérienne</span></div><i class="bi bi-chevron-right sidebar-chevron"></i>
        </a>
        <ul class="collapse list-unstyled" id="collapseSecu">
            <!-- LOGIQUE CORRIGÉE ET SIMPLIFIÉE -->
            <li><a href="{% url 'qs:tableau-bord-qs' %}" class="ps-4">Tableau des FNE</a></li>
           
        </ul>
    </li>
    {% endif %}

    <!-- BLOC 4 : LIENS UNIVERSELS -->
    <hr>
    
    <!-- AJOUT DU LIEN UNIVERSEL POUR TOUS LES AGENTS -->
    {% if user.is_authenticated and user.agent_profile.centre %}
        <li>
            <a href="{% url 'qs:pre-declarer-fne' user.agent_profile.centre.id %}" class="text-warning">
                <i class="bi bi-shield-exclamation"></i>Déclarer un Événement QS
            </a>
        </li>
    {% endif %}

    <li><a href="{% url 'suivi:tableau-actions' %}"><i class="bi bi-clipboard2-data-fill"></i>Tableau de Suivi</a></li>
    <hr>
    {% if user.is_staff %}
    <li>
        <a href="#adminSubmenu" data-bs-toggle="collapse" aria-expanded="false" class="dropdown-toggle"><i class="bi bi-gear-fill"></i>Administration</a>
        <ul class="collapse list-unstyled" id="adminSubmenu">
            <li><a href="#" class="ps-4">Gestion Utilisateurs</a></li>
            <li><a href="#" class="ps-4">Paramètres</a></li>
        </ul>
    </li>
    {% endif %}
</ul>