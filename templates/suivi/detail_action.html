<!-- Fichier : templates/suivi/detail_action.html (Version Finale Corrigée) -->
{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}{{ titre }} - GIRREX{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'suivi:tableau-actions' %}">Tableau de Suivi</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ action.numero_action|default:action.titre }}</li>
        </ol>
    </nav>

    <div class="row g-4">
        <!-- Colonne de gauche : Informations et Historique -->
        <div class="col-md-7">
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">{{ action.titre }}</h4>
                    <span class="badge fs-6 
                        {% if action.statut == 'A_FAIRE' %}bg-secondary
                        {% elif action.statut == 'EN_COURS' %}bg-primary
                        {% elif action.statut == 'A_VALIDER' %}bg-warning text-dark
                        {% elif action.statut == 'VALIDEE' and action.avancement < 100 %}bg-info text-dark
                        {% elif action.statut == 'VALIDEE' %}bg-success
                        {% elif action.statut == 'REFUSEE' %}bg-danger
                        {% endif %}">
                        {{ action.get_statut_display }}
                    </span>
                </div>
                <div class="card-body">
                    <p><strong>Description :</strong> {{ action.description|default:"Aucune description."|linebreaksbr }}</p>
                    <hr>
                    <h5>Détails</h5>
                    <ul>
                        <li><strong>Catégorie :</strong> {{ action.get_categorie_display }}</li>
                        {% if action.centres.all %}
                            <li><strong>Périmètre :</strong> 
                                {% for centre in action.centres.all %}
                                    {{ centre.code_centre }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </li>
                        {% else %}
                            <li><strong>Périmètre :</strong> National</li>
                        {% endif %}
                        <li><strong>Responsable :</strong> {{ action.responsable }}</li>
                        <li><strong>Échéance :</strong> {{ action.echeance|date:"d/m/Y" }}</li>
                        <li><strong>Priorité :</strong> {{ action.get_priorite_display }}</li>
                    </ul>
                    
                    {% if action.objet_source and action.content_type.model == 'document' %}
                        <div class="mt-3 p-3 bg-light border rounded">
                            <h6 class="mb-2">Document à consulter :</h6>
                            <p class="mb-2">
                                <strong>{{ action.objet_source.reference }}</strong><br>
                                <small class="text-muted">{{ action.objet_source.intitule }}</small>
                            </p>
                            <a href="{% url 'documentation:view-pdf' action.objet_source.id %}" target="_blank" class="btn btn-sm btn-primary">
                                <i class="bi bi-eye-fill"></i> Visualiser le PDF
                            </a>
                            <a href="{% url 'documentation:download-pdf' action.objet_source.id %}" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-download"></i> Télécharger
                            </a>
                        </div>
                    {% endif %}

                    <div class="mt-4">
                        <!-- ========================================================== -->
                        <!--                DÉBUT DE LA CORRECTION                    -->
                        <!-- ========================================================== -->
                        
                        {# Scénario 1 : Tâche de dispatch pour un responsable local (condition inchangée) #}
                        {% if action.statut == 'A_FAIRE' and action.responsable == user.agent_profile and action.titre|slice:":11" == 'Dispatcher' %}
                            <a href="#" class="btn btn-lg btn-success">
                                <i class="bi bi-diagram-3-fill"></i> Dispatcher aux Agents du Centre
                            </a>
                        {% endif %}
                        
                        {# Scénario 2 : Tâche de Prise en Compte (condition modifiée) #}
                        {# La nouvelle condition vérifie que la prise en compte n'a PAS encore été faite #}
                        {% if action.categorie == 'PRISE_EN_COMPTE_DOC' and not action.prise_en_compte and action.responsable == user.agent_profile %}
                             <form method="post" action="{% url 'suivi:valider-prise-en-compte' action.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-lg btn-primary">
                                    <i class="bi bi-check2-circle"></i> Confirmer la lecture et la prise en compte
                                </button>
                            </form>
                        {% endif %}

                        <!-- ========================================================== -->
                        <!--                  FIN DE LA CORRECTION                      -->
                        <!-- ========================================================== -->
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header"><h5>Historique de l'Action</h5></div>
                <ul class="list-group list-group-flush">
                    {% for event in historique %}
                        <li class="list-group-item">
                            <p class="mb-1">
                                <strong>{{ event.get_type_evenement_display }}</strong> par <strong>{{ event.auteur.username }}</strong>
                                le {{ event.timestamp|date:"d/m/Y à H:i" }}
                            </p>
                            {% if event.type_evenement == 'CHANGEMENT_AVANCEMENT' %}
                                <small class="text-muted">
                                    Statut: {{ event.details.ancien_statut }} -> {{ event.details.nouveau_statut }} | 
                                    Avancement: {{ event.details.ancien_avancement }} -> {{ event.details.nouvel_avancement }}
                                </small>
                                {% if event.details.commentaire %}
                                    <p class="mb-0 mt-1 fst-italic">"{{ event.details.commentaire }}"</p>
                                {% endif %}
                            {% elif event.details.ancien and event.details.nouveau %}
                                <small class="text-muted">Passage de "{{ event.details.ancien }}" à "{{ event.details.nouveau }}"</small>
                            {% elif event.details.commentaire %}
                                <small class="text-muted fst-italic">"{{ event.details.commentaire }}"</small>
                            {% endif %}
                        </li>
                    {% empty %}
                        <li class="list-group-item text-muted">Aucun événement enregistré pour cette action.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <!-- Colonne de droite : Workflow et Pilotage -->
        <div class="col-md-5">

            <!-- BLOC DE VALIDATION (MODIFIÉ POUR L'INITIATEUR) -->
            {% if action.statut == 'A_VALIDER' %}
                {% if is_initiateur_action_mere %}
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-success text-white"><h5>Clôture Finale Requise</h5></div>
                        <div class="card-body">
                            <p>Toutes les sous-tâches sont terminées. En tant qu'initiateur, vous pouvez clôturer définitivement cette action.</p>
                            <form method="post" action="{% url 'suivi:cloture-initiateur' action.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success">Clôturer l'action à 100%</button>
                            </form>
                        </div>
                    </div>
                
                {% elif action.responsable == user.agent_profile %}
                    <div class="card shadow-sm mb-4">
                        <div class="card-header"><h5>Validation Requise</h5></div>
                        <div class="card-body">
                            <p>Toutes les sous-tâches sont terminées. Veuillez valider cette étape.</p>
                            <form method="post" action="{% url 'suivi:valider-etape' action.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary">Valider cette étape (reste à 99%)</button>
                            </form>
                        </div>
                    </div>
                {% endif %}
            {% endif %}

            <!-- BLOC DE PILOTAGE (pour toutes les actions non terminées) -->
            {% if action.responsable == user.agent_profile and action.statut != 'VALIDEE' %}
                <div class="card shadow-sm mb-4">
                    <div class="card-header"><h5>Piloter l'Action</h5></div>
                    <div class="card-body">
                        <form method="post">
                            {% csrf_token %}
                            {{ update_form|crispy }}
                            <button type="submit" name="update_action" class="btn btn-primary mt-3">Mettre à jour l'action</button>
                        </form>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}